# 开发问题

- [订单问题](#订单问题）
- [资金问题](#资金问题)
- [服务高可用](#服务高可用)
- [数据大屏](#数据大屏)
- [设备管理界面](#设备管理界面)
- [定位系统](#定位系统)
- [支付系统（购物车、订单）](#支付系统（购物车、订单）)
- [营销额分析](#营销额分析)
- [资源投放](#资源投放)
- [服务迁移](#服务迁移)
- [部署脚本](#部署脚本)
- [TODO](#TODO)

## 订单问题
场站端和平台端的商品详情存在重复
应该是场站使用平台管理，平台端管理所有订单信息
![image.png](https://api.apifox.cn/api/v1/projects/2429864/resources/372272/image-preview)
选用合适的设计模式，设计订单结算的服务接口，实现多态性


## 资金问题
乘客与车主仅通过设备关联，（购物车功能）
车主端与场站存在直接资金往来（补货购物车功能）


## 服务高可用
数据库分库分表，建立隔离事务，redis部署集群


## 数据大屏
以场站的销售额为准
广告统计：需要哪些信息，限制条数
热卖排行：场站供应的货品销量（销售额）榜
司机定位信息：哪些司机需要定位？与场站之间存在订单未取货关系的司机
## 设备管理界面
进入界面分页展示所有订单信息，每页 ？ 行（点击这个页面后就已经获取到了所有需要的信息了）30行
其余选项（激活，在线）前端可以自行过滤筛选

## 定位系统
调用GPS API 或许用户实时信息
用户购物时存储用户购物时的车主位置信息
司机挑选补货场站时获取场站的地理位置信息（绝对地址和相对地址）

## 支付系统（购物车、订单）
结算系统调用支付宝API（需要学习)
订单信息传递（车主补货
乘客购买商品，司机端设备接收到购物信息，收集资金数据，更新车主端的资金数据
车主在选货列表中挑选场站以及它们拥有的商品，添加进购物车
* 在购物车中选择特定商品，选定后付款信息打包成订单信息，开启线程发送到服务端，接收到返回信息，表示远端信息处理完毕，之后再更新本地数据（更新pgsql里的订单信息，设备商品信息，还要更新车主端的销量信息）
* 服务器端处理过程：车主端向场站发送补货请求，场站端接收到订单信息（状态为1），司机资金流动到场站，场站平台拆分司机订单中的货品信息,向redis数据库发送信号，依次更新
统计数据
结算接口的幂等性（如果因为服务延迟导致用户在一次服务响应之前发送了多次请求，最后结果应该与用户只发送一次请求保持一致）
分布式数据锁的设计:redission+redlock or set nx ex+lua

## 营销额分析
建立redis数据库
应用数据结构 bitmap,list(每天的营销额）,zset,hash，GEORadius
建立特殊时间戳函数：获取每周，月，年的第一天的信息
* 所有数据库都要有垃圾清理机制
Sort 机制：建立排行榜
ZRankByLex：
### bitmap存储用户连续登录信息，优化用户登录状态判定
### list 存储每日营销额的连续变化数据，list存储每日营业，每周，每月，每年，总营销额:存储累计营销额
（创建守护进程，时刻维护着每个场站/车主的营销日、周、月、年、总营销额，做垃圾清理)
七日连续营销额，当日营销额以及前6天的营销额做累加即可做即可
Key: Product_ID:date
val:营业额
### hash 存储
### GEOXXX 存储场站经纬度信息
key: factory_id/factory_name/场站地址(xx路xx号）
val: 经度、纬度
利用Georadius获取在以车主为中心一定范围内的场站到车主的距离
### Zset （key，val，score）存储营销额排行榜
Key: owner_id:type(daily,weekly,monthly,yearly):date(2006-01-02:15:04:05)：
Val:object_id
Score:销量
分布式策略，管道通信，广播机制



## 资源投放
在服务器上存放视频资源，图片资源，利用ftp技术传输资源，利用minio搭建本地资源服务器


## 服务迁移
从windows移动到linux（感觉没有问题，问题主要在于数据库迁移）
## 部署脚本
shell脚本，dockerfile ,docker-compose

## TODO:
升级单体架构成为微服务架构
RPC,go-zero,consul/etcd
